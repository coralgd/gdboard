<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>GDBoard - Ник</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
<canvas id="hud-bg"></canvas>

<div class="panel">
  <h2>Отправьте свой ник</h2>
  <div class="row">
    <input type="text" id="nickInput" placeholder="Ваш ник">
    <div class="actions">
      <button id="sendNick">Отправить</button>
    </div>
  </div>
  <p id="status">not requested</p>
</div>

<script type="module">
import { auth, db } from "./firebase.js";
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

onAuthStateChanged(auth, async user => {
  if(!user) location.href="index.html";

  const ref = doc(db,"users",user.uid);
  const snap = await getDoc(ref);

  if(!snap.exists()){
    await setDoc(ref,{
      nick:"",
      points:0,
      situation:"not requested",
      role:"player"
    });
  }

  const data = (await getDoc(ref)).data();

  // Редирект только если VERIFIED
  if(data.situation==="verified"){
    location.href="main.html";
  }

  document.getElementById("sendNick").onclick = async () => {
    const nick = document.getElementById("nickInput").value.trim();
    if(!nick) return alert("Введите ник!");
    await updateDoc(ref,{nick, situation:"requested"});
    document.getElementById("status").innerText="requested";
  };
});
</script>
<script src="hudBackground.js"></script>
</body>
</html>
