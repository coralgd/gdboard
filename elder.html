<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
<canvas id="hud-bg"></canvas>
<div class="panel" id="list"></div>

<script type="module">
import { auth, db } from "./firebase.js";
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { collection, getDocs, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

onAuthStateChanged(auth, async user => {
  if(!user) location.href="index.html";
  const me = await getDoc(doc(db,"users",user.uid));
  if(me.data().role!=="elder") location.href="main.html";

  const snap = await getDocs(collection(db,"users"));

  snap.forEach(d=>{
    const u=d.data();
    const row=document.createElement("div");
    row.className="row";

    let modBtnText = (u.role==="moderator") ? "Снять Модера" : "Сделать Модером";
    let modBtnClass = (u.role==="moderator") ? "danger" : "";
    let verBtnText = (u.situation==="verified") ? "Снять Вериф" : "Вериф";
    let verBtnClass = (u.situation==="verified") ? "danger" : "";

    row.innerHTML=`
      <div>#</div>
      <div>${u.nick||"(no nick)"}</div>
      <input type="number" value="${u.points||0}">
      <div class="actions">
        <button class="pointsBtn">Изменить</button>
        <button class="${verBtnClass} verBtn">${verBtnText}</button>
        <button class="${modBtnClass} modBtn">${modBtnText}</button>
      </div>
    `;

    const pointsInput = row.querySelector("input");
    row.querySelector(".pointsBtn").onclick = ()=>updateDoc(d.ref,{points:+pointsInput.value});
    row.querySelector(".verBtn").onclick = async ()=>{
      const newStatus = (u.situation==="verified")?"not verified":"verified";
      await updateDoc(d.ref,{situation:newStatus});
      row.querySelector(".verBtn").innerText = (newStatus==="verified")?"Снять Вериф":"Вериф";
      row.querySelector(".verBtn").className = (newStatus==="verified")?"danger verBtn":"verBtn";
      u.situation=newStatus;
    };
    row.querySelector(".modBtn").onclick = async ()=>{
      const newRole = (u.role==="moderator")?"player":"moderator";
      await updateDoc(d.ref,{role:newRole});
      row.querySelector(".modBtn").innerText = (newRole==="moderator")?"Снять Модера":"Сделать Модером";
      row.querySelector(".modBtn").className = (newRole==="moderator")?"danger modBtn":"modBtn";
      u.role=newRole;
    };

    list.append(row);
  });
});
</script>
<script src="hudBackground.js"></script>
</body>
</html>
