<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Панель старшего модератора</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
    import { 
      getFirestore, 
      collection, 
      getDocs, 
      doc, 
      updateDoc,
      getDoc
    } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB7QbVxGHR7Qm8o8Wzl_wxsCpzMUdS5rws",
      authDomain: "gdboard-add4a.firebaseapp.com",
      projectId: "gdboard-add4a",
      storageBucket: "gdboard-add4a.firebasestorage.app",
      messagingSenderId: "883125028740",
      appId: "1:883125028740:web:c504de4139943b8606bfd1"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const usersList = document.getElementById("usersList");
    const logoutBtn = document.getElementById("logoutBtn");

    onAuthStateChanged(auth, async (user) => {
      if (!user) return window.location.href = "index.html";

      // Проверка роли текущего пользователя
      const currentUserSnap = await getDoc(doc(db, "users", user.uid));
      if (!currentUserSnap.exists()) return window.location.href = "main.html";
      if (currentUserSnap.data().role !== "elder") return window.location.href = "main.html";

      // Загружаем всех пользователей
      const usersRef = collection(db, "users");
      const snapshot = await getDocs(usersRef);

      snapshot.forEach((docItem) => {
        const data = docItem.data();

        const li = document.createElement("li");
        li.style.marginBottom = "10px";

        // Ник
        const nickSpan = document.createElement("span");
        nickSpan.textContent = data.nick || "Не указан";
        nickSpan.style.marginRight = "10px";
        li.appendChild(nickSpan);

        // Input очков
        const pointsInput = document.createElement("input");
        pointsInput.type = "number";
        pointsInput.value = data.points || 0;
        pointsInput.style.width = "60px";
        li.appendChild(pointsInput);

        // Кнопка изменения очков
        const pointsBtn = document.createElement("button");
        pointsBtn.textContent = "Изменить очки";
        pointsBtn.style.marginLeft = "5px";
        pointsBtn.addEventListener("click", async () => {
          const newPoints = parseInt(pointsInput.value);
          if (isNaN(newPoints)) return;
          await updateDoc(doc(db, "users", docItem.id), { points: newPoints });
          alert(`Очки ${data.nick} изменены на ${newPoints}`);
        });
        li.appendChild(pointsBtn);

        // Кнопка модерации
        const modBtn = document.createElement("button");
        modBtn.style.marginLeft = "5px";
        if (data.role === "moderator") {
          modBtn.textContent = "Снять модерку";
        } else {
          modBtn.textContent = "Назначить модером";
        }
        modBtn.addEventListener("click", async () => {
          const newRole = (data.role === "moderator") ? "player" : "moderator";
          await updateDoc(doc(db, "users", docItem.id), { role: newRole });
          alert(`Роль ${data.nick} изменена на ${newRole}`);
          location.reload(); // Обновляем страницу, чтобы кнопка изменилась
        });
        li.appendChild(modBtn);

        // Кнопка верификации
        const verifBtn = document.createElement("button");
        verifBtn.style.marginLeft = "5px";
        if (data.situation === "verified") {
          verifBtn.textContent = "Снять верификацию";
        } else {
          verifBtn.textContent = "Верифицировать";
        }
        verifBtn.addEventListener("click", async () => {
          const newSituation = (data.situation === "verified") ? "not requested" : "verified";
          await updateDoc(doc(db, "users", docItem.id), { situation: newSituation });
          alert(`${data.nick} теперь ${newSituation}`);
          location.reload(); // обновляем кнопку
        });
        li.appendChild(verifBtn);

        usersList.appendChild(li);
      });
    });

    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "index.html";
    });
  </script>
</head>
<body>
  <h1>Панель старшего модератора</h1>
  <ul id="usersList"></ul>
  <button id="logoutBtn">Выйти</button>
</body>
</html>
