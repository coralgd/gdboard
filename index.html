<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Лидерборд</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
<canvas id="hud-bg"></canvas>

<div class="panel">
  <h2>Лидерборд</h2>
  <div id="board" class="table"></div>
</div>

<script type="module">
import { auth, db } from "./firebase.js";
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { collection, getDocs, query, where, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

onAuthStateChanged(auth, async user => {
  if(!user) location.href="index.html";

  const boardContainer = document.getElementById("board");
  boardContainer.innerHTML = "";

  // Только verified пользователи, сортировка по points desc
  const q = query(
    collection(db,"users"),
    where("situation","==","verified"),
    orderBy("points","desc")
  );

  const snapshot = await getDocs(q);

  let lastPoints = null;
  let place = 0;
  let skip = 1;

  snapshot.docs.forEach(docSnap => {
    const data = docSnap.data();
    let displayPlace;

    if(lastPoints === data.points){
      displayPlace = place;
      skip++;
    } else {
      place += skip;
      displayPlace = place;
      skip = 1;
      lastPoints = data.points;
    }

    // Ник текущего пользователя
    let nickDisplay = data.nick;
    if(docSnap.id === user.uid) nickDisplay = `${data.nick} (Вы)`;

    // Роль
    let roleDisplay = "";
    if(data.role==="moderator") roleDisplay="Модер";
    if(data.role==="elder") roleDisplay="Старший модер";

    // В одну строку через пробел
    const row = document.createElement("div");
    row.classList.add("row");
    row.innerText = `${displayPlace} ${nickDisplay} ${data.points} ${roleDisplay}`;

    boardContainer.appendChild(row);
  });
});
</script>
<script src="hudBackground.js"></script>
</body>
</html>
