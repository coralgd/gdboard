<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Лидерборд</title>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
import { getFirestore, collection, query, where, getDocs, doc, getDoc, orderBy } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyB7QbVxGHR7Qm8o8Wzl_wxsCpzMUdS5rws",
  authDomain: "gdboard-add4a.firebaseapp.com",
  projectId: "gdboard-add4a",
  storageBucket: "gdboard-add4a.firebasestorage.app",
  messagingSenderId: "883125028740",
  appId: "1:883125028740:web:c504de4139943b8606bfd1"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const leaderboardList = document.getElementById("leaderboardList");

onAuthStateChanged(auth, async (user) => {
  if (!user) return window.location.href = "index.html";

  const userDocSnap = await getDoc(doc(db, "users", user.uid));
  if (!userDocSnap.exists()) return window.location.href = "index.html";

  const data = userDocSnap.data();
  const role = data.role || "player";
  const situation = data.situation || "not requested";

  if (role === "player" && situation !== "verified") return window.location.href = "nick.html";

  const usersRef = collection(db, "users");
  const q = query(usersRef, where("situation", "==", "verified"), orderBy("points", "desc"));
  const snapshot = await getDocs(q);

  leaderboardList.innerHTML = "";

  const usersArray = snapshot.docs.map(docItem => ({ id: docItem.id, ...docItem.data() }));

  let prevPoints = null;
  let prevRank = 0;

  usersArray.forEach((userData, index) => {
    const li = document.createElement("li");
    const points = userData.points || 0;

    // Спортивная система рангов
    let rank;
    if (points === prevPoints) {
      rank = prevRank; // одинаковое место для одинаковых баллов
    } else {
      rank = index + 1; // новое место = индекс + 1
      prevPoints = points;
      prevRank = rank;
    }

    // Формируем строку: Ник — Баллы — Роль
    let line = `${userData.nick || "Не указан"} — ${points}`;
    if (userData.role === "moderator") line += " Модер";
    if (userData.role === "elder") line += " Старший модер";

    if (userData.id === user.uid) li.style.color = "blue";

    li.textContent = `${rank}. ${line}`;
    leaderboardList.appendChild(li);
  });
});
</script>
</head>
<body>
<h1>Лидерборд</h1>
<ol id="leaderboardList" style="list-style: none; padding-left: 0;"></ol>
</body>
</html>
