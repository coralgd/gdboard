<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>GDBoard - Лидерборд</title>
<link rel="stylesheet" href="styles.css">
</head>
<body>

<div class="panel">
  <h2>Лидерборд</h2>
  <div id="leaderboard"></div>
</div>

<script type="module">
import { db, auth } from "./firebase.js";
import { collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const leaderboardContainer = document.getElementById("leaderboard");

async function loadLeaderboard() {
  const q = query(collection(db,"users"), orderBy("points","desc"));
  const snapshot = await getDocs(q);
  let users = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));

  let rank = 1;
  let prevPoints = null;
  let skipRank = 0;

  users.forEach((user, index) => {
    let place = "";

    if(user.points > 0){
      if(prevPoints !== null){
        if(user.points === prevPoints){
          skipRank++;
        } else {
          rank += 1 + skipRank;
          skipRank = 0;
        }
      }
      place = rank;
      prevPoints = user.points;
    }

    const userDiv = document.createElement("div");
    userDiv.className = "leader-row";

    let roleText = "";
    if(user.role === "moderator") roleText = "Модер";
    if(user.role === "elder") roleText = "Старший модер";

    userDiv.innerHTML = `
      ${user.points} — ${user.nick} ${roleText ? roleText : ""} ${place ? place : ""}
    `;

    if(auth.currentUser && auth.currentUser.uid === user.id){
      userDiv.classList.add("current-player");
    }

    leaderboardContainer.appendChild(userDiv);
  });
}

loadLeaderboard();
</script>

</body>
</html>
