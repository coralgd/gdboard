<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Leaderboard</title>
<link rel="stylesheet" href="styles.css">
</head>
<body>

<div class="app">
  <div class="panel">
    <h1>Лидерборд</h1>
    <div class="hud-line"></div>

    <div class="list" id="list"></div>
  </div>
</div>

<script src="hudBackground.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
import { getFirestore, collection, getDocs, query, where, orderBy } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

const app = initializeApp({
  apiKey: "AIzaSyB7QbVxGHR7Qm8o8Wzl_wxsCpzMUdS5rws",
  authDomain: "gdboard-add4a.firebaseapp.com",
  projectId: "gdboard-add4a"
});

const auth = getAuth(app);
const db = getFirestore(app);

const list = document.getElementById("list");

onAuthStateChanged(auth, async user => {
  if (!user) return location.href = "index.html";

  const q = query(
    collection(db, "users"),
    where("situation", "==", "verified"),
    orderBy("points", "desc")
  );

  const snap = await getDocs(q);

  let place = 0;
  let lastPoints = null;
  let shown = 0;

  snap.forEach(docu => {
    const u = docu.data();
    shown++;

    if (u.points !== lastPoints) {
      place = shown;
      lastPoints = u.points;
    }

    const row = document.createElement("div");
    row.className = "row" + (docu.id === user.uid ? " me" : "");

    let roleClass = "";
    let roleText = "";
    if (u.role === "elder") {
      roleClass = "role-elder";
      roleText = "Старший модер";
    } else if (u.role === "moderator") {
      roleClass = "role-moderator";
      roleText = "Модератор";
    }

    row.innerHTML = `
      <div>${place}</div>
      <div class="${roleClass}">${u.nick} ${roleText}</div>
      <div>${u.points}</div>
      <div></div>
    `;

    list.appendChild(row);
  });
});
</script>
</body>
</html>
